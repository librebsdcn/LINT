# 15.3 IPFilter（IPF）

IPF（IPFilter，IP 过滤器）是一款开源软件，作者 Darren Reed。以下仅供参考，未经测试。

如果想启用 ipf，可以执行以下命令：

```sh
# 复制示例文件作为默认配置规则集文件，否则 ipfilter 启动后会没有规则。示例文件自带的规则不影响使用
# cp /usr/share/examples/ipfilter/ipf.conf.sample /etc/ipf.rules
```

- 启动 ipfilter

```sh
# service ipfilter enable   # 设置 ipfilter 在系统启动时自动启动
# service ipfilter start    # 启动 ipfilter 服务
```

- 启动 ipnat

ipnat 是 IPF 的一部分，专门用于处理 NAT 规则的维护。

```sh
# cp /usr/share/examples/ipfilter/ipnat.conf.sample /etc/ipnat.rules   # 复制示例文件作为默认配置规则集，否则 ipnat 无法启动
# service ipnat enable   # 设置 ipnat 在系统启动时自动启动
# service ipnat start    # 启动 ipnat 服务
```

注意，ipfilter 服务重启后，ipnat 也需要重启。

---

ipf 的管理命令主要用 ipf、ipfstat 和 ipnat，常用操作示例如下：

可以将你提供的 `ipfilter`（IPF）命令和规则说明拆分如下：

---

### IPF 命令操作

1. **启动 IPF**

```sh
ipf -E
```

作用：启用 IPF 防火墙，相当于 `service ipfilter start`。

---

2. **停止 IPF**

```sh
ipf -D
```

作用：禁用 IPF 防火墙，相当于 `service ipfilter stop`。

---

3. **加载规则集文件**

```sh
ipf -f /etc/ipf.rules
```

作用：从指定文件加载防火墙规则。

---

4. **查看所有规则**

```sh
ipfstat
```

作用：显示当前加载的所有规则。

---

5. **查看详细规则信息**

```sh
ipfstat -iohn
```

作用：

* `i`：显示输入规则
* `o`：显示输出规则
* `h`：显示通过该规则的流量
* `n`：显示规则编号

---

6. **进入监控模式**

```sh
ipfstat -t
```

作用：实时监控 IPF 流量，按 `Q` 退出。

---

7. **清理已加载规则**

```sh
ipf -Fa
```

作用：删除所有已加载的规则。

---

### NAT 操作命令

1. **加载 NAT 规则**

```sh
ipnat -f /etc/ipnat.rules
```

作用：加载 NAT 规则文件。

---

2. **汇总 NAT 状态**

```sh
ipnat -s
```

作用：显示 NAT 的运行状态汇总。

---

3. **列表显示 NAT 规则**

```sh
ipnat -lh
```

作用：列出 NAT 规则，`h` 表示显示通过该规则的流量。

---

4. **清理 NAT 规则**

```sh
ipnat -CF
```

作用：删除已加载的 NAT 规则。

---

### IPF 规则说明

1. **拒绝所有访问**

```sh
block all
```

作用：阻止所有流量。
说明：IPF 默认是明示禁止的防火墙，需要明确写规则以阻止访问。

---

2. **拒绝所有进入流量**

```sh
block in all
```

作用：阻止所有入站流量。
说明：

* `block`：拒绝
* `pass`：允许
* `in`：入站（`out` 表示出站）
* `all`：等价于 `from any to any`

---

3. **地址表示**

* IP 或网段：如 `192.168.1.100` 或 `192.168.1.0/24`
* `any`：任意地址



```
# 拒绝所有外部流量
block out all  # 放开回环接口的访问权限，回环接口不对外部

# 放行所有回环接口流量
pass in quick on lo0 all  # quick 关键字表示若规则匹配，就停止执行，不会再执行后续规则

# 放行所有回环接口输出流量
pass out quick on lo0 all  # 放开回环接口的访问权限，回环接口不对外部

# 允许任何设备以 TCP 协议访问本机 80 端口
pass in quick proto tcp from any to 192.168.1.184 port = 80  # proto tcp 是访问协议，常用值有 tcp、udp、tcp/udp、icmp，不写则表示支持所有协议；port = 80 是目标端口

# 允许本机向外发送回显信息
pass out quick proto tcp from 192.168.1.184 to any  # 允许回显信息给任何访问的设备

# 增加 80 端口到 8080 端口流量转发的规则
rdr em0 192.168.1.184 port 80 -> 192.168.1.184 port 8080  # 转发流量到本机的 8080 端口，通常用来进行端口映射

# 允许本机通过 ICMP 协议 ping 外部设备
pass out quick proto icmp from 192.168.1.184 to any icmp-type 8 keep state  # ICMP type 8 是查询请求，keep state 表示维持状态

# 允许外部设备通过 ICMP 协议 ping 本机
pass in quick proto icmp from any to 192.168.1.184 icmp-type 8 keep state  # 允许任何外部设备 ping 本机

# 允许本机通过 ICMP 协议进行 traceroute
pass out quick proto icmp from 192.168.1.184 to any icmp-type 0  # ICMP type 0 是回显应答

# 允许本机通过 UDP 协议进行 traceroute，端口号从 33434 开始，每转发一次端口号加 1
pass out quick proto udp from 192.168.1.184 to any port 33434 >< 34500 keep state  # traceroute 默认使用 UDP 协议，端口号从 33434 开始
```

常用的规则集文件 `/etc/ipf.rules` 如下：

```
# 拒绝所有进入的流量
block in all  # 拒绝任何来自外部的输入流量

# 拒绝所有外出的流量
block out all  # 拒绝任何从本机出去的流量

# 放行回环接口的所有流量
pass in quick on lo0 all  # 允许本机与回环接口之间的通信

# 放行回环接口的所有输出流量
pass out quick on lo0 all  # 允许回环接口向外发送数据

# 设置任何设备可以访问服务器的 22、80、443、4200、10000 端口
pass in quick proto tcp from any to 192.168.1.184 port = { 22,80,443,4200,10000 }  # 允许外部设备通过 TCP 协议访问本机指定端口

# 允许本机向外发送 22、80、443、4200、10000 端口的流量
pass out quick proto tcp from 192.168.1.184 port = { 22,80,443,4200,10000 } to any  # 允许本机通过 TCP 协议访问任何外部设备的这些端口

# 允许本机访问外部设备的 80 和 443 端口，并保持连接状态
pass out quick proto tcp from 192.168.1.184 to any port = { 80,443 } keep state  # 设置本机访问任何网络设备的 80、443 端口并保持连接状态

# 设置本机访问 DNS 服务器
pass out quick proto udp from any to any port = 53 keep state  # 允许本机通过 UDP 协议访问任何 DNS 服务器的 53 端口

# 设置本机访问 DHCP 服务器
pass out quick proto udp from any to any port = 67 keep state  # 允许本机通过 UDP 协议访问 DHCP 服务器的 67 端口

# 允许本机向任何外部设备发送 ICMP ping 请求
pass out quick proto icmp from 192.168.1.184 to any icmp-type 8 keep state  # ICMP type 8 表示查询请求，keep state 维护状态

# 允许外部设备向本机发送 ICMP ping 请求
pass in quick proto icmp from any to 192.168.1.184 icmp-type 8 keep state  # 允许外部设备 ping 本机

# 允许本机向任何外部设备发送 ICMP 回显应答
pass out quick proto icmp from 192.168.1.184 to any icmp-type 0  # ICMP type 0 是回显应答，允许本机响应 ping 请求

# 设置本机使用 UDP 协议进行 traceroute，端口号从 33434 开始，逐步增加
pass out quick proto udp from 192.168.1.184 to any port 33434 >< 34500 keep state  # traceroute 默认使用 UDP 协议，端口号从 33434 开始

# 数据转发前要放开相应端口，允许外部设备访问本机 8080 端口
pass in quick proto tcp from any to 192.168.1.184 port = 8080  # 允许外部设备通过 TCP 协议访问本机的 8080 端口
```

常用的 NAT 规则集文件 `/etc/ipnat.rules` 如下：

```
# 设置本机 8080 端口到 80 端口的流量转发
rdr on em0 proto tcp from any to 192.168.1.184 port 8080 -> 192.168.1.184 port 80 # 将来自本机 em0 网卡的 8080 端口流量转发到本机的 80 端口
```

保存文件，接下来在终端执行命令：

```
# 清理已加载的所有规则，并加载 /etc/ipf.rules 文件中的规则
ipf -Fa -f /etc/ipf.rules  # -Fa 清理所有规则，-f 用来加载指定的规则文件

# 清理已加载的所有 NAT 规则，并加载 /etc/ipnat.rules 文件中的 NAT 规则
ipnat -CF -f /etc/ipnat.rules  # -CF 清理 NAT 规则，-f 用来加载指定的 NAT 规则文件
```

